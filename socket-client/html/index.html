<!DOCTYPE html>
<html>
<head>
    <title></title>
    <script type="application/javascript" src="http.js"></script>
    <script type="application/javascript" src="scripts.js"></script>
    <style>
        .hidden {
            display: none;
        }

        #currentChannel {
            font-size: 2em;
            font-weight: bold;
        }
    </style>
</head>
<body>
<!--
STATES:
- initial
- name entered
- session started
- joined session
- transferring files

ACTIONS:
- enter name
- start session
- join session
- upload file(s)
- download file(s)
-->
    <h1>Channel</h1>
    <div id="currentChannel"></div>
    <div>
        <input id="channel" type="text" name="handle" value="" size="50" />
        <button type="button" onclick="setChannel()">Join channel</button>
    </div>

    <h1>Channel members</h1>
    <div id="members"></div>

    <h1>Name</h1>
    <div>
        <input id="handle" type="text" name="handle" value="" size="50" />
        <button type="button" onclick="setHandle()">Set name</button>
    </div>

    <h1>Upload file</h1>
    <form id="form1" enctype="multipart/form-data" method="post" action="../src/upload_stream.php">
        <div class="row">
            <label for="fileToUpload">Select a File to Upload</label><br />
            <input type="file" name="fileToUpload" id="fileToUpload" onchange="fileSelected();"/>
        </div>
        <div id="fileName"></div>
        <div id="fileSize"></div>
        <div id="fileType"></div>
        <div class="row">
            <input type="button" onclick="uploadFile()" value="Upload" />
        </div>
        <div id="progressNumber"></div>
    </form>

    <h1>Received files</h1>
    <div id="files"></div>

    <h1>Tasks</h1>
    <input type="button" name="reset" value="Reset session" onclick="resetFiles()" />
</body>
</html>


<script>
    function setChannel() {
        var channel = document.getElementById('channel').value;
        conn.send(JSON.stringify({
            command: "joinChannel",
            channel: channel
        }));
    }

    function setHandle() {
        var name = document.getElementById('handle').value;
        conn.send(JSON.stringify({
            command: "name",
            name: name
        }));
    }

    function showFiles(files) {
        console.log('showFiles', files);
        var result = "<ul>";

        for (var channelId in files.channels) {
            files.channels[channelId].forEach(function(file) {
                result +=
                    "<li>" +
                    file.filename +
                    "<a href='/api/download/" +
                    channelId +
                    '/' +
                    file.uploadName +
                    "'> (download)</a>"
                    + "</li>";
            });
        }

        result += "</ul>";
        document.getElementById("files").innerHTML = result;
    }

    startSession();

    var conn = new WebSocket('ws://localhost:8081');
    conn.onopen = function (e) {
        console.log("Connection established!");
        console.log(getCookie('PHPSESSID'));

        // getSession().then(function (channelId) {
        //     if (channelId === null) {
        //         startSession('test', function(channelId) {
        //             console.log('started a new session');
        //             getFileList(channelId).then(showFiles);
        //         });
        //     } else {
        //         console.log('joined an existing session');
        //         joinChannel(channelId);
        //         getFileList(channelId).then(showFiles);
        //     }
        // });
    };

    conn.onmessage = function (e) {
        var data = JSON.parse(e.data);
        console.log("onMessage", data);

        if (data.channel) {
            var element = document.getElementById('currentChannel');
            removeChildren(element);

            var newText = document.createTextNode(data.channel);
            element.appendChild(newText);

            document.getElementById('channel').value = data.channel;

            var element = document.getElementById('members');
            removeChildren(element);

            data.members.forEach(function(member) {
                var span = document.createElement('div')
                var text = document.createTextNode(member.name);
                span.appendChild(text);
                element.appendChild(span);
            });
        }

        if (data.yourName) {
            document.getElementById('handle').value = data.yourName;
        }
    };

    function removeChildren(element) {
        while(element.childNodes.length >= 1) {
            element.removeChild(element.firstChild);
        }
    }
</script>
