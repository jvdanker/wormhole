<!DOCTYPE html>
<html>
<head>
    <title></title>
    <script type="application/javascript" src="http.js"></script>
    <script type="application/javascript" src="scripts.js"></script>
    <style>
        .hidden {
            display: none;
        }

        #currentChannel {
            font-size: 2em;
            font-weight: bold;
        }
    </style>
</head>
<body>
<!--
STATES:
- initial
- name entered
- session started
- joined session
- transferring files

ACTIONS:
- enter name
- start session
- join session
- upload file(s)
- download file(s)
-->
    <h1>Channel</h1>
    <div id="currentChannel"></div>
    <div>
        <input id="channel" type="text" name="handle" value="" size="50" />
        <button type="button" onclick="setChannel()">set channel</button>
    </div>

    <h1>Members</h1>
    <div id="members"></div>

    <div>
        <input id="handle" type="text" name="handle" value="work computer" />
        <button type="button" onclick="setHandle()">set handle</button>
    </div>

    <form id="form1" enctype="multipart/form-data" method="post" action="../src/upload_stream.php">
        <div class="row">
            <label for="fileToUpload">Select a File to Upload</label><br />
            <input type="file" name="fileToUpload" id="fileToUpload" onchange="fileSelected();"/>
        </div>
        <div id="fileName"></div>
        <div id="fileSize"></div>
        <div id="fileType"></div>
        <div class="row">
            <input type="button" onclick="uploadFile()" value="Upload" />
        </div>
        <div id="progressNumber"></div>
    </form>

    <h1>Files</h1>
    <div id="files"></div>
    <div class="hasfiles hidden">
        <input type="button" name="reset" value="Reset" onclick="resetFiles()" />
    </div>

    <input type="button" name="reset" value="Reset" onclick="resetFiles()" />

    <script>
        function setChannel() {
            var channel = document.getElementById('channel').value;
            conn.send(JSON.stringify({
                command: "joinChannel",
                channel: channel
            }));
        }

        function setHandle() {
            var name = document.getElementById('handle').value;
            conn.send(JSON.stringify({
                command: "name",
                name: name
            }));
        }

        function showFiles(files) {
            console.log('showFiles', files);
            var result = "<ul>";

            for (var channelId in files.channels) {
                files.channels[channelId].forEach(function(file) {
                    result +=
                        "<li>" +
                        file.filename +
                        "<a href='/api/download/" +
                        channelId +
                        '/' +
                        file.uploadName +
                        "'> (download)</a>"
                        + "</li>";
                });
            }

            result += "</ul>";
            document.getElementById("files").innerHTML = result;
        }

        startSession();

        var conn = new WebSocket('ws://localhost:8081');
        conn.onopen = function (e) {
            console.log("Connection established!");
            console.log(getCookie('PHPSESSID'));

            // getSession().then(function (channelId) {
            //     if (channelId === null) {
            //         startSession('test', function(channelId) {
            //             console.log('started a new session');
            //             getFileList(channelId).then(showFiles);
            //         });
            //     } else {
            //         console.log('joined an existing session');
            //         joinChannel(channelId);
            //         getFileList(channelId).then(showFiles);
            //     }
            // });
        };

        conn.onmessage = function (e) {
            var data = JSON.parse(e.data);
            console.log("onMessage", data);

            if (data.channel) {
                var element = document.getElementById('currentChannel');
                while(element.childNodes.length >= 1) {
                    element.removeChild(element.firstChild);
                }

                var newText = document.createTextNode(data.channel);
                element.appendChild(newText);

                document.getElementById('channel').value = data.channel;

                var element = document.getElementById('members');
                data.members.forEach(function(member) {
                    var newText = document.createTextNode(member.name);
                    element.appendChild(newText);
                });
            }
        };
    </script>
</body>
</html>